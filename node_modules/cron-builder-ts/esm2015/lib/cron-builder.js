import * as Cron from "cron-converter";
import { CronValidator } from './cron-validator';
import { DEFAULT_INTERVAL, MEASURE_OF_TIME_MAP } from './types';
import { keys } from './utils';
/**
 * Initializes a CronBuilder with an optional initial cron expression.
 * @param {String=} initialExpression - if provided, it must be up to 5 space delimited parts
 * @throws {Error} if the initialExpression is bogus
 * @constructor
 */
export class CronBuilder {
    constructor(initialExpression = "* * * * *") {
        if (initialExpression) {
            CronValidator.validateString(initialExpression);
            const splitExpression = initialExpression.split(' ');
            this.expression = {
                minute: splitExpression[0] ? splitExpression[0].split(",") : DEFAULT_INTERVAL,
                hour: splitExpression[1] ? splitExpression[1].split(",") : DEFAULT_INTERVAL,
                dayOfTheMonth: splitExpression[2] ? splitExpression[2].split(",") : DEFAULT_INTERVAL,
                month: splitExpression[3] ? splitExpression[3].split(",") : DEFAULT_INTERVAL,
                dayOfTheWeek: splitExpression[4] ? splitExpression[4].split(",") : DEFAULT_INTERVAL,
            };
        }
        else {
            this.expression = {
                minute: DEFAULT_INTERVAL,
                hour: DEFAULT_INTERVAL,
                dayOfTheMonth: DEFAULT_INTERVAL,
                month: DEFAULT_INTERVAL,
                dayOfTheWeek: DEFAULT_INTERVAL,
            };
        }
    }
    /**
     * builds a working cron expression based on the state of the cron object
     * @param {!Object} [options] - customize how to build cron string
     * @param {!Boolean} [options.plain=true] - get cron string as it is, otherwise build short cron string.
     * if false: * 13 * 1-6 0,1,2,3,5,6 ---> * 13 * 1-6 0-3,5-6
     * @param {!Boolean} [options.outputWeekdayNames=false] - changes the numbers to 3 letter weekday names.
     * if true: *\/5 9-17/2 * 1-3 1-5 ---> *\/5 *(10-16)/2 * JAN-MAR MON-FRI
     * @param {!Boolean} [options.outputMonthNames=false] - changes the numbers to 3 letter month names.
     * if true: *\/5 9-17/2 * 1-3 1-5 ---> *\/5 *(10-16)/2 * JAN-MAR MON-FRI
     * @param {!Boolean} [options.outputHashes=false] - changes the * to H.
     * if true: *\/5 9-17/2 * 1-3 1-5 ---> H/5 H(10-16)/2 H 1-3 1-5
     * @returns {string} - working cron expression
     */
    build(options) {
        const { plain, } = options !== null && options !== void 0 ? options : { plain: true };
        const cronString = [
            this.expression.minute.join(','),
            this.expression.hour.join(','),
            this.expression.dayOfTheMonth.join(','),
            this.expression.month.join(','),
            this.expression.dayOfTheWeek.join(','),
        ].join(' ');
        if (plain) {
            return cronString;
        }
        const cronInstance = new Cron(options);
        cronInstance.fromString(cronString);
        return cronInstance.toString();
    }
    /**
     * adds a value to what exists currently (builds)
     * @param {!String} measureOfTime
     * @param {!String} value
     * @throws {Error} if measureOfTime or value fail validation
     */
    addValue(measureOfTime, value) {
        CronValidator.validateValue(measureOfTime, value);
        if (this.expression[measureOfTime].length === 1 && this.expression[measureOfTime][0] === '*') {
            this.expression[measureOfTime] = [value];
        }
        else {
            if (this.expression[measureOfTime].indexOf(value) < 0) {
                this.expression[measureOfTime].push(value);
            }
        }
    }
    ;
    /**
     * removes a single explicit value (subtracts)
     * @param {!String} measureOfTime - as you might guess
     * @param {!String} value - the offensive value
     * @throws {Error} if measureOfTime is bogus.
     */
    removeValue(measureOfTime, value) {
        if (!this.expression[measureOfTime]) {
            throw new Error(`Invalid measureOfTime: Valid options are: ${MEASURE_OF_TIME_MAP.join(', ')}`);
        }
        if (this.expression[measureOfTime].length === 1 && this.expression[measureOfTime][0] === '*') {
            console.log('The value for "' + measureOfTime + '" is already at the default value of "*" - this is a no-op.');
            return;
        }
        this.expression[measureOfTime] = this.expression[measureOfTime].filter((timeValue) => {
            return value !== timeValue;
        });
        if (!this.expression[measureOfTime].length) {
            this.expression[measureOfTime] = DEFAULT_INTERVAL;
        }
    }
    ;
    get(measureOfTime, options) {
        if (!this.expression[measureOfTime]) {
            throw new Error(`Invalid measureOfTime: Valid options are: ${MEASURE_OF_TIME_MAP.join(', ')}`);
        }
        const { expand, } = options !== null && options !== void 0 ? options : { expand: false };
        if (!expand) {
            return this.expression[measureOfTime].join(',');
        }
        const expression = this.getAll({ expand });
        return expression[measureOfTime];
    }
    getAll(options) {
        const { expand, } = options !== null && options !== void 0 ? options : { expand: false };
        if (!expand) {
            return this.expression;
        }
        const cronString = this.build({ plain: true });
        const cronInstance = new Cron();
        cronInstance.fromString(cronString);
        const cronArray = cronInstance.toArray();
        return {
            minute: cronArray[0],
            hour: cronArray[1],
            dayOfTheMonth: cronArray[2],
            month: cronArray[3],
            dayOfTheWeek: cronArray[4],
        };
    }
    /**
     * sets the state of a given measureOfTime
     * @param {!String} measureOfTime - yup
     * @param {!Array.<String>} value - the 5 tuple array of values to set
     * @returns {!String} the comma separated version of the value that you passed in
     * @throws {Error} if your "value" is not an Array&lt;String&gt;
     * @throws {Error} when any item in your value isn't a legal cron-ish descriptor
     */
    set(measureOfTime, value) {
        if (!Array.isArray(value)) {
            throw new Error('Invalid value; Value must be in the form of an Array.');
        }
        for (const item of value) {
            CronValidator.validateValue(measureOfTime, item);
        }
        this.expression[measureOfTime] = value;
        return this.expression[measureOfTime].join(',');
    }
    /**
     * sets the state for the entire cron expression
     * @param {!{
     *  minute: Array.string,
     *  hour: Array.string,
     *  dayOfTheMonth: Array.string,
     *  month: Array.string,
     *  dayOfTheWeek: Array.string,
     * }} expToSet - the entirety of the cron expression.
     * @throws {Error} as usual
     */
    setAll(expToSet) {
        CronValidator.validateExpression(expToSet);
        keys(this.expression).forEach((key) => this.expression[key] = expToSet[key]);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3Jvbi1idWlsZGVyLmpzIiwic291cmNlUm9vdCI6Im5nOi8vY3Jvbi1idWlsZGVyLXRzLyIsInNvdXJjZXMiOlsibGliL2Nyb24tYnVpbGRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEtBQUssSUFBSSxNQUFNLGdCQUFnQixDQUFDO0FBRXZDLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUNqRCxPQUFPLEVBQUUsZ0JBQWdCLEVBQWtDLG1CQUFtQixFQUFFLE1BQU0sU0FBUyxDQUFDO0FBQ2hHLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFFL0I7Ozs7O0dBS0c7QUFDSCxNQUFNLE9BQU8sV0FBVztJQUd0QixZQUFZLG9CQUE0QixXQUFXO1FBQ2pELElBQUksaUJBQWlCLEVBQUU7WUFDckIsYUFBYSxDQUFDLGNBQWMsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO1lBRWhELE1BQU0sZUFBZSxHQUFHLGlCQUFpQixDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUVyRCxJQUFJLENBQUMsVUFBVSxHQUFHO2dCQUNoQixNQUFNLEVBQUUsZUFBZSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxnQkFBZ0I7Z0JBQzdFLElBQUksRUFBRSxlQUFlLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLGdCQUFnQjtnQkFDM0UsYUFBYSxFQUFFLGVBQWUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsZ0JBQWdCO2dCQUNwRixLQUFLLEVBQUUsZUFBZSxDQUFD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YSxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ2xELENBQUM7SUFFRDs7Ozs7Ozs7OztPQVVHO0lBQ0ksTUFBTSxDQUFDLFFBQW9CO1FBQ2hDLGFBQWEsQ0FBQyxrQkFBa0IsQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUUzQyxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsR0FBRyxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQTtJQUM5RSxDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBDcm9uIGZyb20gXCJjcm9uLWNvbnZlcnRlclwiO1xyXG5cclxuaW1wb3J0IHsgQ3JvblZhbGlkYXRvciB9IGZyb20gJy4vY3Jvbi12YWxpZGF0b3InO1xyXG5pbXBvcnQgeyBERUZBVUxUX0lOVEVSVkFMLCBFeHBhbmRlZEV4cHJlc3Npb24sIEV4cHJlc3Npb24sIE1FQVNVUkVfT0ZfVElNRV9NQVAgfSBmcm9tICcuL3R5cGVzJztcclxuaW1wb3J0IHsga2V5cyB9IGZyb20gJy4vdXRpbHMnO1xyXG5cclxuLyoqXHJcbiAqIEluaXRpYWxpemVzIGEgQ3JvbkJ1aWxkZXIgd2l0aCBhbiBvcHRpb25hbCBpbml0aWFsIGNyb24gZXhwcmVzc2lvbi5cclxuICogQHBhcmFtIHtTdHJpbmc9fSBpbml0aWFsRXhwcmVzc2lvbiAtIGlmIHByb3ZpZGVkLCBpdCBtdXN0IGJlIHVwIHRvIDUgc3BhY2UgZGVsaW1pdGVkIHBhcnRzXHJcbiAqIEB0aHJvd3Mge0Vycm9yfSBpZiB0aGUgaW5pdGlhbEV4cHJlc3Npb24gaXMgYm9ndXNcclxuICogQGNvbnN0cnVjdG9yXHJcbiAqL1xyXG5leHBvcnQgY2xhc3MgQ3JvbkJ1aWxkZXIge1xyXG4gIHByaXZhdGUgcmVhZG9ubHkgZXhwcmVzc2lvbjogRXhwcmVzc2lvbjtcclxuXHJcbiAgY29uc3RydWN0b3IoaW5pdGlhbEV4cHJlc3Npb246IHN0cmluZyA9IFwiKiAqICogKiAqXCIpIHtcclxuICAgIGlmIChpbml0aWFsRXhwcmVzc2lvbikge1xyXG4gICAgICBDcm9uVmFsaWRhdG9yLnZhbGlkYXRlU3RyaW5nKGluaXRpYWxFeHByZXNzaW9uKTtcclxuXHJcbiAgICAgIGNvbnN0IHNwbGl0RXhwcmVzc2lvbiA9IGluaXRpYWxFeHByZXNzaW9uLnNwbGl0KCcgJyk7XHJcblxyXG4gICAgICB0aGlzLmV4cHJlc3Npb24gPSB7XHJcbiAgICAgICAgbWludXRlOiBzcGxpdEV4cHJlc3Npb25bMF0gPyBzcGxpdEV4cHJlc3Npb25bMF0uc3BsaXQoXCIsXCIpIDogREVGQVVMVF9JTlRFUlZBTCxcclxuICAgICAgICBob3VyOiBzcGxpdEV4cHJlc3Npb25bMV0gPyBzcGxpdEV4cHJlc3Npb25bMV0uc3BsaXQoXCIsXCIpIDogREVGQVVMVF9JTlRFUlZBTCxcclxuICAgICAgICBkYXlPZlRoZU1vbnRoOiBzcGxpdEV4cHJlc3Npb25bMl0gPyBzcGxpdEV4cHJlc3Npb25bMl0uc3BsaXQoXCIsXCIpIDogREVGQVVMVF9JTlRFUlZBTCxcclxuICAgICAgICBtb250aDogc3BsaXRFeHByZXNzaW9uWzNdID8gc3BsaXRFeHByZXNzaW9uWzNdLnNwbGl0KFwiLFwiKSA6IERFRkFVTFRfSU5URVJWQUwsXHJcbiAgICAgICAgZGF5T2ZUaGVXZWVrOiBzcGxpdEV4cHJlc3Npb25bNF0gPyBzcGxpdEV4cHJlc3Npb25bNF0uc3BsaXQoXCIsXCIpIDogREVGQVVMVF9JTlRFUlZBTCxcclxuICAgICAgfTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHRoaXMuZXhwcmVzc2lvbiA9IHtcclxuICAgICAgICBtaW51dGU6IERFRkFVTFRfSU5URVJWQUwsXHJcbiAgICAgICAgaG91cjogREVGQVVMVF9JTlRFUlZBTCxcclxuICAgICAgICBkYXlPZlRoZU1vbnRoOiBERUZBVUxUX0lOVEVSVkFMLFxyXG4gICAgICAgIG1vbnRoOiBERUZBVUxUX0lOVEVSVkFMLFxyXG4gICAgICAgIGRheU9mVGhlV2VlazogREVGQVVMVF9JTlRFUlZBTCxcclxuICAgICAgfTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIGJ1aWxkcyBhIHdvcmtpbmcgY3JvbiBleHByZXNzaW9uIGJhc2VkIG9uIHRoZSBzdGF0ZSBvZiB0aGUgY3JvbiBvYmplY3RcclxuICAgKiBAcGFyYW0geyFPYmplY3R9IFtvcHRpb25zXSAtIGN1c3RvbWl6ZSBob3cgdG8gYnVpbGQgY3JvbiBzdHJpbmdcclxuICAgKiBAcGFyYW0geyFCb29sZWFufSBbb3B0aW9ucy5wbGFpbj10cnVlXSAtIGdldCBjcm9uIHN0cmluZyBhcyBpdCBpcywgb3RoZXJ3aXNlIGJ1aWxkIHNob3J0IGNyb24gc3RyaW5nLlxyXG4gICAqIGlmIGZhbHNlOiAqIDEzICogMS02IDAsMSwyLDMsNSw2IC0tLT4gKiAxMyAqIDEtNiAwLTMsNS02XHJcbiAgICogQHBhcmFtIHshQm9vbGVhbn0gW29wdGlvbnMub3V0cHV0V2Vla2RheU5hbWVzPWZhbHNlXSAtIGNoYW5nZXMgdGhlIG51bWJlcnMgdG8gMyBsZXR0ZXIgd2Vla2RheSBuYW1lcy5cclxuICAgKiBpZiB0cnVlOiAqXFwvNSA5LTE3LzIgKiAxLTMgMS01IC0tLT4gKlxcLzUgKigxMC0xNikvMiAqIEpBTi1NQVIgTU9OLUZSSVxyXG4gICAqIEBwYXJhbSB7IUJvb2xlYW59IFtvcHRpb25zLm91dHB1dE1vbnRoTmFtZXM9ZmFsc2VdIC0gY2hhbmdlcyB0aGUgbnVtYmVycyB0byAzIGxldHRlciBtb250aCBuYW1lcy5cclxuICAgKiBpZiB0cnVlOiAqXFwvNSA5LTE3LzIgKiAxLTMgMS01IC0tLT4gKlxcLzUgKigxMC0xNikvMiAqIEpBTi1NQVIgTU9OLUZSSVxyXG4gICAqIEBwYXJhbSB7IUJvb2xlYW59IFtvcHRpb25zLm91dHB1dEhhc2hlcz1mYWxzZV0gLSBjaGFuZ2VzIHRoZSAqIHRvIEguXHJcbiAgICogaWYgdHJ1ZTogKlxcLzUgOS0xNy8yICogMS0zIDEtNSAtLS0+IEgvNSBIKDEwLTE2KS8yIEggMS0zIDEtNVxyXG4gICAqIEByZXR1cm5zIHtzdHJpbmd9IC0gd29ya2luZyBjcm9uIGV4cHJlc3Npb25cclxuICAgKi9cclxuICBwdWJsaWMgYnVpbGQob3B0aW9ucz86IHsgcGxhaW46IGJvb2xlYW4gfCB1bmRlZmluZWQgfSAmIE9taXQ8Q3Jvbi5PcHRpb25zLCBcInRpbWV6b25lXCI+KTogc3RyaW5nIHtcclxuICAgIGNvbnN0IHtcclxuICAgICAgcGxhaW4sXHJcbiAgICB9ID0gb3B0aW9ucyA/PyB7IHBsYWluOiB0cnVlIH07XHJcblxyXG4gICAgY29uc3QgY3JvblN0cmluZyA9IFtcclxuICAgICAgdGhpcy5leHByZXNzaW9uLm1pbnV0ZS5qb2luKCcsJyksXHJcbiAgICAgIHRoaXMuZXhwcmVzc2lvbi5ob3VyLmpvaW4oJywnKSxcclxuICAgICAgdGhpcy5leHByZXNzaW9uLmRheU9mVGhlTW9udGguam9pbignLCcpLFxyXG4gICAgICB0aGlzLmV4cHJlc3Npb24ubW9udGguam9pbignLCcpLFxyXG4gICAgICB0aGlzLmV4cHJlc3Npb24uZGF5T2ZUaGVXZWVrLmpvaW4oJywnKSxcclxuICAgIF0uam9pbignICcpO1xyXG5cclxuICAgIGlmIChwbGFpbikge1xyXG4gICAgICByZXR1cm4gY3JvblN0cmluZztcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBjcm9uSW5zdGFuY2UgPSBuZXcgQ3JvbihvcHRpb25zKTtcclxuICAgIGNyb25JbnN0YW5jZS5mcm9tU3RyaW5nKGNyb25TdHJpbmcpO1xyXG5cclxuICAgIHJldHVybiBjcm9uSW5zdGFuY2UudG9TdHJpbmcoKTtcclxuICB9XHJcblxyXG5cclxuICAvKipcclxuICAgKiBhZGRzIGEgdmFsdWUgdG8gd2hhdCBleGlzdHMgY3VycmVudGx5IChidWlsZHMpXHJcbiAgICogQHBhcmFtIHshU3RyaW5nfSBtZWFzdXJlT2ZUaW1lXHJcbiAgICogQHBhcmFtIHshU3RyaW5nfSB2YWx1ZVxyXG4gICAqIEB0aHJvd3Mge0Vycm9yfSBpZiBtZWFzdXJlT2ZUaW1lIG9yIHZhbHVlIGZhaWwgdmFsaWRhdGlvblxyXG4gICAqL1xyXG4gIHB1YmxpYyBhZGRWYWx1ZShtZWFzdXJlT2ZUaW1lOiBrZXlvZiBFeHByZXNzaW9uLCB2YWx1ZTogc3RyaW5nKTogdm9pZCB7XHJcbiAgICBDcm9uVmFsaWRhdG9yLnZhbGlkYXRlVmFsdWUobWVhc3VyZU9mVGltZSwgdmFsdWUpO1xyXG5cclxuICAgIGlmICh0aGlzLmV4cHJlc3Npb25bbWVhc3VyZU9mVGltZV0ubGVuZ3RoID09PSAxICYmIHRoaXMuZXhwcmVzc2lvblttZWFzdXJlT2ZUaW1lXVswXSA9PT0gJyonKSB7XHJcbiAgICAgIHRoaXMuZXhwcmVzc2lvblttZWFzdXJlT2ZUaW1lXSA9IFt2YWx1ZV07XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBpZiAodGhpcy5leHByZXNzaW9uW21lYXN1cmVPZlRpbWVdLmluZGV4T2YodmFsdWUpIDwgMCkge1xyXG4gICAgICAgIHRoaXMuZXhwcmVzc2lvblttZWFzdXJlT2ZUaW1lXS5wdXNoKHZhbHVlKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH07XHJcblxyXG4gIC8qKlxyXG4gICAqIHJlbW92ZXMgYSBzaW5nbGUgZXhwbGljaXQgdmFsdWUgKHN1YnRyYWN0cylcclxuICAgKiBAcGFyYW0geyFTdHJpbmd9IG1lYXN1cmVPZlRpbWUgLSBhcyB5b3UgbWlnaHQgZ3Vlc3NcclxuICAgKiBAcGFyYW0geyFTdHJpbmd9IHZhbHVlIC0gdGhlIG9mZmVuc2l2ZSB2YWx1ZVxyXG4gICAqIEB0aHJvd3Mge0Vycm9yfSBpZiBtZWFzdXJlT2ZUaW1lIGlzIGJvZ3VzLlxyXG4gICAqL1xyXG4gIHB1YmxpYyByZW1vdmVWYWx1ZShtZWFzdXJlT2ZUaW1lOiBrZXlvZiBFeHByZXNzaW9uLCB2YWx1ZTogc3RyaW5nKTogdm9pZCB7XHJcbiAgICBpZiAoIXRoaXMuZXhwcmVzc2lvblttZWFzdXJlT2ZUaW1lXSkge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgbWVhc3VyZU9mVGltZTogVmFsaWQgb3B0aW9ucyBhcmU6ICR7TUVBU1VSRV9PRl9USU1FX01BUC5qb2luKCcsICcpfWApO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICh0aGlzLmV4cHJlc3Npb25bbWVhc3VyZU9mVGltZV0ubGVuZ3RoID09PSAxICYmIHRoaXMuZXhwcmVzc2lvblttZWFzdXJlT2ZUaW1lXVswXSA9PT0gJyonKSB7XHJcbiAgICAgIGNvbnNvbGUubG9nKCdUaGUgdmFsdWUgZm9yIFwiJyArIG1lYXN1cmVPZlRpbWUgKyAnXCIgaXMgYWxyZWFkeSBhdCB0aGUgZGVmYXVsdCB2YWx1ZSBvZiBcIipcIiAtIHRoaXMgaXMgYSBuby1vcC4nKTtcclxuXHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICB0aGlzLmV4cHJlc3Npb25bbWVhc3VyZU9mVGltZV0gPSB0aGlzLmV4cHJlc3Npb25bbWVhc3VyZU9mVGltZV0uZmlsdGVyKCh0aW1lVmFsdWUpID0+IHtcclxuICAgICAgcmV0dXJuIHZhbHVlICE9PSB0aW1lVmFsdWU7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpZiAoIXRoaXMuZXhwcmVzc2lvblttZWFzdXJlT2ZUaW1lXS5sZW5ndGgpIHtcclxuICAgICAgdGhpcy5leHByZXNzaW9uW21lYXN1cmVPZlRpbWVdID0gREVGQVVMVF9JTlRFUlZBTDtcclxuICAgIH1cclxuICB9O1xyXG5cclxuICAvKipcclxuICAgKiByZXR1cm5zIHRoZSBjdXJyZW50IHN0YXRlIG9mIGEgZ2l2ZW4gbWVhc3VyZU9mVGltZVxyXG4gICAqIEBwYXJhbSB7IVN0cmluZ30gbWVhc3VyZU9mVGltZSBvbmUgb2YgXCJtaW51dGVcIiwgXCJob3VyXCIsIGV0Y1xyXG4gICAqIEByZXR1cm5zIHshQXJyYXkubnVtYmVyfSBjb21tYSBzZXBhcmF0ZWQgYmxhaCBibGFoXHJcbiAgICogQHRocm93cyB7RXJyb3J9IGlmIHRoZSBtZWFzdXJlT2ZUaW1lIGlzIG5vdCBvbmUgb2YgdGhlIHBlcm1pdHRlZCB2YWx1ZXMuXHJcbiAgICovXHJcbiAgcHVibGljIGdldChtZWFzdXJlT2ZUaW1lOiBrZXlvZiBFeHByZXNzaW9uLCBvcHRpb25zOiB7IGV4cGFuZDogdHJ1ZSB9KTogbnVtYmVyW11cclxuICAvKipcclxuICAgKiByZXR1cm5zIHRoZSBjdXJyZW50IHN0YXRlIG9mIGEgZ2l2ZW4gbWVhc3VyZU9mVGltZVxyXG4gICAqIEBwYXJhbSB7IVN0cmluZ30gbWVhc3VyZU9mVGltZSBvbmUgb2YgXCJtaW51dGVcIiwgXCJob3VyXCIsIGV0Y1xyXG4gICAqIEByZXR1cm5zIHshU3RyaW5nfSBjb21tYSBzZXBhcmF0ZWQgYmxhaCBibGFoXHJcbiAgICogQHRocm93cyB7RXJyb3J9IGlmIHRoZSBtZWFzdXJlT2ZUaW1lIGlzIG5vdCBvbmUgb2YgdGhlIHBlcm1pdHRlZCB2YWx1ZXMuXHJcbiAgICovXHJcbiAgcHVibGljIGdldChtZWFzdXJlT2ZUaW1lOiBrZXlvZiBFeHByZXNzaW9uLCBvcHRpb25zPzogeyBleHBhbmQ6IGZhbHNlIH0pOiBzdHJpbmdcclxuICBwdWJsaWMgZ2V0KG1lYXN1cmVPZlRpbWU6IGtleW9mIEV4cHJlc3Npb24sIG9wdGlvbnM/OiB7IGV4cGFuZDogYm9vbGVhbiB9KTogc3RyaW5nIHwgbnVtYmVyW10ge1xyXG4gICAgaWYgKCF0aGlzLmV4cHJlc3Npb25bbWVhc3VyZU9mVGltZV0pIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIG1lYXN1cmVPZlRpbWU6IFZhbGlkIG9wdGlvbnMgYXJlOiAke01FQVNVUkVfT0ZfVElNRV9NQVAuam9pbignLCAnKX1gKTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCB7XHJcbiAgICAgIGV4cGFuZCxcclxuICAgIH0gPSBvcHRpb25zID8/IHsgZXhwYW5kOiBmYWxzZSB9O1xyXG5cclxuICAgIGlmICghZXhwYW5kKSB7XHJcbiAgICAgIHJldHVybiB0aGlzLmV4cHJlc3Npb25bbWVhc3VyZU9mVGltZV0uam9pbignLCcpO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IGV4cHJlc3Npb24gPSB0aGlzLmdldEFsbCh7IGV4cGFuZCB9KTtcclxuXHJcbiAgICByZXR1cm4gZXhwcmVzc2lvblttZWFzdXJlT2ZUaW1lXTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFJldHVybnMgYSByaWNoIG9iamVjdCB0aGF0IGRlc2NyaWJlcyB0aGUgY3VycmVudCBzdGF0ZSBvZiB0aGUgY3JvbiBleHByZXNzaW9uLlxyXG4gICAqIEByZXR1cm5zIHshe1xyXG4gICAqICBtaW51dGU6IEFycmF5Lm51bWJlcixcclxuICAgKiAgaG91cjogQXJyYXkubnVtYmVyLFxyXG4gICAqICBkYXlPZlRoZU1vbnRoOiBBcnJheS5udW1iZXIsXHJcbiAgICogIG1vbnRoOiBBcnJheS5udW1iZXIsXHJcbiAgICogIGRheU9mVGhlV2VlazogQXJyYXkubnVtYmVyLFxyXG4gICAqIH19XHJcbiAgICovXHJcbiAgcHVibGljIGdldEFsbChvcHRpb25zOiB7IGV4cGFuZDogdHJ1ZSB9KTogRXhwYW5kZWRFeHByZXNzaW9uXHJcbiAgLyoqXHJcbiAgICogUmV0dXJucyBhIHJpY2ggb2JqZWN0IHRoYXQgZGVzY3JpYmVzIHRoZSBjdXJyZW50IHN0YXRlIG9mIHRoZSBjcm9uIGV4cHJlc3Npb24uXHJcbiAgICogQHJldHVybnMgeyF7XHJcbiAgICogIG1pbnV0ZTogQXJyYXkuc3RyaW5nLFxyXG4gICAqICBob3VyOiBBcnJheS5zdHJpbmcsXHJcbiAgICogIGRheU9mVGhlTW9udGg6IEFycmF5LnN0cmluZyxcclxuICAgKiAgbW9udGg6IEFycmF5LnN0cmluZyxcclxuICAgKiAgZGF5T2ZUaGVXZWVrOiBBcnJheS5zdHJpbmcsXHJcbiAgICogfX1cclxuICAgKi9cclxuICBwdWJsaWMgZ2V0QWxsKG9wdGlvbnM/OiB7IGV4cGFuZDogZmFsc2UgfSk6IEV4cHJlc3Npb25cclxuICBwdWJsaWMgZ2V0QWxsKG9wdGlvbnM/OiB7IGV4cGFuZDogYm9vbGVhbiB9KTogRXhwcmVzc2lvbiB8IEV4cGFuZGVkRXhwcmVzc2lvbiB7XHJcbiAgICBjb25zdCB7XHJcbiAgICAgIGV4cGFuZCxcclxuICAgIH0gPSBvcHRpb25zID8/IHsgZXhwYW5kOiBmYWxzZSB9O1xyXG5cclxuICAgIGlmICghZXhwYW5kKSB7XHJcbiAgICAgIHJldHVybiB0aGlzLmV4cHJlc3Npb247XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgY3JvblN0cmluZyA9IHRoaXMuYnVpbGQoeyBwbGFpbjogdHJ1ZSB9KTtcclxuICAgIGNvbnN0IGNyb25JbnN0YW5jZSA9IG5ldyBDcm9uKCk7XHJcbiAgICBjcm9uSW5zdGFuY2UuZnJvbVN0cmluZyhjcm9uU3RyaW5nKTtcclxuICAgIGNvbnN0IGNyb25BcnJheSA9IGNyb25JbnN0YW5jZS50b0FycmF5KCk7XHJcblxyXG4gICAgcmV0dXJuIHtcclxuICAgICAgbWludXRlOiBjcm9uQXJyYXlbMF0sXHJcbiAgICAgIGhvdXI6IGNyb25BcnJheVsxXSxcclxuICAgICAgZGF5T2ZUaGVNb250aDogY3JvbkFycmF5WzJdLFxyXG4gICAgICBtb250aDogY3JvbkFycmF5WzNdLFxyXG4gICAgICBkYXlPZlRoZVdlZWs6IGNyb25BcnJheVs0XSxcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIHNldHMgdGhlIHN0YXRlIG9mIGEgZ2l2ZW4gbWVhc3VyZU9mVGltZVxyXG4gICAqIEBwYXJhbSB7IVN0cmluZ30gbWVhc3VyZU9mVGltZSAtIHl1cFxyXG4gICAqIEBwYXJhbSB7IUFycmF5LjxTdHJpbmc+fSB2YWx1ZSAtIHRoZSA1IHR1cGxlIGFycmF5IG9mIHZhbHVlcyB0byBzZXRcclxuICAgKiBAcmV0dXJucyB7IVN0cmluZ30gdGhlIGNvbW1hIHNlcGFyYXRlZCB2ZXJzaW9uIG9mIHRoZSB2YWx1ZSB0aGF0IHlvdSBwYXNzZWQgaW5cclxuICAgKiBAdGhyb3dzIHtFcnJvcn0gaWYgeW91ciBcInZhbHVlXCIgaXMgbm90IGFuIEFycmF5Jmx0O1N0cmluZyZndDtcclxuICAgKiBAdGhyb3dzIHtFcnJvcn0gd2hlbiBhbnkgaXRlbSBpbiB5b3VyIHZhbHVlIGlzbid0IGEgbGVnYWwgY3Jvbi1pc2ggZGVzY3JpcHRvclxyXG4gICAqL1xyXG4gIHB1YmxpYyBzZXQobWVhc3VyZU9mVGltZToga2V5b2YgRXhwcmVzc2lvbiwgdmFsdWU6IHN0cmluZ1tdKTogc3RyaW5nIHtcclxuICAgIGlmICghQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIHZhbHVlOyBWYWx1ZSBtdXN0IGJlIGluIHRoZSBmb3JtIG9mIGFuIEFycmF5LicpO1xyXG4gICAgfVxyXG5cclxuICAgIGZvciAoY29uc3QgaXRlbSBvZiB2YWx1ZSkge1xyXG4gICAgICBDcm9uVmFsaWRhdG9yLnZhbGlkYXRlVmFsdWUobWVhc3VyZU9mVGltZSwgaXRlbSk7XHJcbiAgICB9XHJcblxyXG4gICAgdGhpcy5leHByZXNzaW9uW21lYXN1cmVPZlRpbWVdID0gdmFsdWU7XHJcblxyXG4gICAgcmV0dXJuIHRoaXMuZXhwcmVzc2lvblttZWFzdXJlT2ZUaW1lXS5qb2luKCcsJyk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBzZXRzIHRoZSBzdGF0ZSBmb3IgdGhlIGVudGlyZSBjcm9uIGV4cHJlc3Npb25cclxuICAgKiBAcGFyYW0geyF7XHJcbiAgICogIG1pbnV0ZTogQXJyYXkuc3RyaW5nLFxyXG4gICAqICBob3VyOiBBcnJheS5zdHJpbmcsXHJcbiAgICogIGRheU9mVGhlTW9udGg6IEFycmF5LnN0cmluZyxcclxuICAgKiAgbW9udGg6IEFycmF5LnN0cmluZyxcclxuICAgKiAgZGF5T2ZUaGVXZWVrOiBBcnJheS5zdHJpbmcsXHJcbiAgICogfX0gZXhwVG9TZXQgLSB0aGUgZW50aXJldHkgb2YgdGhlIGNyb24gZXhwcmVzc2lvbi5cclxuICAgKiBAdGhyb3dzIHtFcnJvcn0gYXMgdXN1YWxcclxuICAgKi9cclxuICBwdWJsaWMgc2V0QWxsKGV4cFRvU2V0OiBFeHByZXNzaW9uKTogdm9pZCB7XHJcbiAgICBDcm9uVmFsaWRhdG9yLnZhbGlkYXRlRXhwcmVzc2lvbihleHBUb1NldCk7XHJcblxyXG4gICAga2V5cyh0aGlzLmV4cHJlc3Npb24pLmZvckVhY2goKGtleSkgPT4gdGhpcy5leHByZXNzaW9uW2tleV0gPSBleHBUb1NldFtrZXldKVxyXG4gIH1cclxufVxyXG4iXX0=