import { __values } from "tslib";
import * as Cron from "cron-converter";
import { CronValidator } from './cron-validator';
import { DEFAULT_INTERVAL, MEASURE_OF_TIME_MAP } from './types';
import { keys } from './utils';
/**
 * Initializes a CronBuilder with an optional initial cron expression.
 * @param {String=} initialExpression - if provided, it must be up to 5 space delimited parts
 * @throws {Error} if the initialExpression is bogus
 * @constructor
 */
var CronBuilder = /** @class */ (function () {
    function CronBuilder(initialExpression) {
        if (initialExpression === void 0) { initialExpression = "* * * * *"; }
        if (initialExpression) {
            CronValidator.validateString(initialExpression);
            var splitExpression = initialExpression.split(' ');
            this.expression = {
                minute: splitExpression[0] ? splitExpression[0].split(",") : DEFAULT_INTERVAL,
                hour: splitExpression[1] ? splitExpression[1].split(",") : DEFAULT_INTERVAL,
                dayOfTheMonth: splitExpression[2] ? splitExpression[2].split(",") : DEFAULT_INTERVAL,
                month: splitExpression[3] ? splitExpression[3].split(",") : DEFAULT_INTERVAL,
                dayOfTheWeek: splitExpression[4] ? splitExpression[4].split(",") : DEFAULT_INTERVAL,
            };
        }
        else {
            this.expression = {
                minute: DEFAULT_INTERVAL,
                hour: DEFAULT_INTERVAL,
                dayOfTheMonth: DEFAULT_INTERVAL,
                month: DEFAULT_INTERVAL,
                dayOfTheWeek: DEFAULT_INTERVAL,
            };
        }
    }
    /**
     * builds a working cron expression based on the state of the cron object
     * @param {!Object} [options] - customize how to build cron string
     * @param {!Boolean} [options.plain=true] - get cron string as it is, otherwise build short cron string.
     * if false: * 13 * 1-6 0,1,2,3,5,6 ---> * 13 * 1-6 0-3,5-6
     * @param {!Boolean} [options.outputWeekdayNames=false] - changes the numbers to 3 letter weekday names.
     * if true: *\/5 9-17/2 * 1-3 1-5 ---> *\/5 *(10-16)/2 * JAN-MAR MON-FRI
     * @param {!Boolean} [options.outputMonthNames=false] - changes the numbers to 3 letter month names.
     * if true: *\/5 9-17/2 * 1-3 1-5 ---> *\/5 *(10-16)/2 * JAN-MAR MON-FRI
     * @param {!Boolean} [options.outputHashes=false] - changes the * to H.
     * if true: *\/5 9-17/2 * 1-3 1-5 ---> H/5 H(10-16)/2 H 1-3 1-5
     * @returns {string} - working cron expression
     */
    CronBuilder.prototype.build = function (options) {
        var plain = (options !== null && options !== void 0 ? options : { plain: true }).plain;
        var cronString = [
            this.expression.minute.join(','),
            this.expression.hour.join(','),
            this.expression.dayOfTheMonth.join(','),
            this.expression.month.join(','),
            this.expression.dayOfTheWeek.join(','),
        ].join(' ');
        if (plain) {
            return cronString;
        }
        var cronInstance = new Cron(options);
        cronInstance.fromString(cronString);
        return cronInstance.toString();
    };
    /**
     * adds a value to what exists currently (builds)
     * @param {!String} measureOfTime
     * @param {!String} value
     * @throws {Error} if measureOfTime or value fail validation
     */
    CronBuilder.prototype.addValue = function (measureOfTime, value) {
        CronValidator.validateValue(measureOfTime, value);
        if (this.expression[measureOfTime].length === 1 && this.expression[measureOfTime][0] === '*') {
            this.expression[measureOfTime] = [value];
        }
        else {
            if (this.expression[measureOfTime].indexOf(value) < 0) {
                this.expression[measureOfTime].push(value);
            }
        }
    };
    ;
    /**
     * removes a single explicit value (subtracts)
     * @param {!String} measureOfTime - as you might guess
     * @param {!String} value - the offensive value
     * @throws {Error} if measureOfTime is bogus.
     */
    CronBuilder.prototype.removeValue = function (measureOfTime, value) {
        if (!this.expression[measureOfTime]) {
            throw new Error("Invalid measureOfTime: Valid options are: " + MEASURE_OF_TIME_MAP.join(', '));
        }
        if (this.expression[measureOfTime].length === 1 && this.expression[measureOfTime][0] === '*') {
            console.log('The value for "' + measureOfTime + '" is already at the default value of "*" - this is a no-op.');
            return;
        }
        this.expression[measureOfTime] = this.expression[measureOfTime].filter(function (timeValue) {
            return value !== timeValue;
        });
        if (!this.expression[measureOfTime].length) {
            this.expression[measureOfTime] = DEFAULT_INTERVAL;
        }
    };
    ;
    CronBuilder.prototype.get = function (measureOfTime, options) {
        if (!this.expression[measureOfTime]) {
            throw new Error("Invalid measureOfTime: Valid options are: " + MEASURE_OF_TIME_MAP.join(', '));
        }
        var expand = (options !== null && options !== void 0 ? options : { expand: false }).expand;
        if (!expand) {
            return this.expression[measureOfTime].join(',');
        }
        var expression = this.getAll({ expand: expand });
        return expression[measureOfTime];
    };
    CronBuilder.prototype.getAll = function (options) {
        var expand = (options !== null && options !== void 0 ? options : { expand: false }).expand;
        if (!expand) {
            return this.expression;
        }
        var cronString = this.build({ plain: true });
        var cronInstance = new Cron();
        cronInstance.fromString(cronString);
        var cronArray = cronInstance.toArray();
        return {
            minute: cronArray[0],
            hour: cronArray[1],
            dayOfTheMonth: cronArray[2],
            month: cronArray[3],
            dayOfTheWeek: cronArray[4],
        };
    };
    /**
     * sets the state of a given measureOfTime
     * @param {!String} measureOfTime - yup
     * @param {!Array.<String>} value - the 5 tuple array of values to set
     * @returns {!String} the comma separated version of the value that you passed in
     * @throws {Error} if your "value" is not an Array&lt;String&gt;
     * @throws {Error} when any item in your value isn't a legal cron-ish descriptor
     */
    CronBuilder.prototype.set = function (measureOfTime, value) {
        var e_1, _a;
        if (!Array.isArray(value)) {
            throw new Error('Invalid value; Value must be in the form of an Array.');
        }
        try {
            for (var value_1 = __values(value), value_1_1 = value_1.next(); !value_1_1.done; value_1_1 = value_1.next()) {
                var item = value_1_1.value;
                CronValidator.validateValue(measureOfTime, item);
            }
        }
        catch (e_1_1) { e_1 = { error: e_1_1 }; }
        finally {
            try {
                if (value_1_1 && !value_1_1.done && (_a = value_1.return)) _a.call(value_1);
            }
            finally { if (e_1) throw e_1.error; }
        }
        this.expression[measureOfTime] = value;
        return this.expression[measureOfTime].join(',');
    };
    /**
     * sets the state for the entire cron expression
     * @param {!{
     *  minute: Array.string,
     *  hour: Array.string,
     *  dayOfTheMonth: Array.string,
     *  month: Array.string,
     *  dayOfTheWeek: Array.string,
     * }} expToSet - the entirety of the cron expression.
     * @throws {Error} as usual
     */
    CronBuilder.prototype.setAll = function (expToSet) {
        var _this = this;
        CronValidator.validateExpression(expToSet);
        keys(this.expression).forEach(function (key) { return _this.expression[key] = expToSet[key]; });
    };
    return CronBuilder;
}());
export { CronBuilder };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3Jvbi1idWlsZGVyLmpzIiwic291cmNlUm9vdCI6Im5nOi8vY3Jvbi1idWlsZGVyLXRzLyIsInNvdXJjZXMiOlsibGliL2Nyb24tYnVpbGRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxLQUFLLElBQUksTUFBTSxnQkFBZ0IsQ0FBQztBQUV2QyxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDakQsT0FBTyxFQUFFLGdCQUFnQixFQUFrQyxtQkFBbUIsRUFBRSxNQUFNLFNBQVMsQ0FBQztBQUNoRyxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBRS9COzs7OztHQUtHO0FBQ0g7SUFHRSxxQkFBWSxpQkFBdUM7UUFBdkMsa0NBQUEsRUFBQSwrQkFBdUM7UUFDakQsSUFBSSxpQkFBaUIsRUFBRTtZQUNyQixhQUFhLENBQUMsY0FBYyxDQUFDLGlCQUFpQixDQUFDLENBQUM7WUFFaEQsSUFBTSxlQUFlLEdBQUcsaUJBQWlCLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBRXJELElBQUksQ0FBQyxVQUFVLEdBQUc7Z0JBQ2hCLE1BQU0sRUFBRSxlQUFlLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLGdCQUFnQjtnQkFDN0UsSUFBSSxFQUFFLGVBQWUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsZ0JBQWdCO2dCQUMzRSxhQUFhLEVBQUUsZUFBZSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxnQkFBZ0I7Z0JBQ3BGLEtBQUssRUFBRSxlQUFlLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLGdCQUFnQjtnQkFDNUUsWUFBWSxFQUFFLGVBQWUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsZ0JBQWdCO2FBQ3BGLENBQUM7U0FDSDthQUFNO1lBQ0wsSUFBSSxDQUFDLFVBQVUsR0FBRztnQkFDaEIsTUFBTSxFQUFFLGdCQUFnQjtnQkFDeEIsSUFBSSxFQUFFLGdCQUFnQjtnQkFDdEIsYUFBYSxFQUFFLGdCQUFnQjtnQkFDL0IsS0FBSyxFQUFFLGdCQUFnQjtnQkFDdkIsWUFBWSxFQUFFLGdCQUFnQjthQUMvQixDQUFDO1NBQ0g7SUFDSCxDQUFDO0lBRUQ7Ozs7Ozs7Ozs7OztPQVlHO0lBQ0ksMkJBQUssR0FBWixVQUFhLE9BQXlFO1FBRWxGLElBQUEsa0ZBQUssQ0FDd0I7UUFFL0IsSUFBTSxVQUFVLEdBQUc7WUFDakIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQztZQUNoQyxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDO1lBQzlCLElBQUksQ0FBQyxVQUFVLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUM7WUFDdkMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQztZQUMvQixJQUFJLENBQUMsVUFBVSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDO1NBQ3ZDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBRVosSUFBSSxLQUFLLEVBQUU7WUFDVCxPQUFPLFVBQVUsQ0FBQztTQUNuQjtRQUVELElBQU0sWUFBWSxHQUFHLElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQ3ZDLFlBQVksQ0FBQyxVQUFVLENBQUMsVUFBVSxDQUFDLENBQUM7UUFFcEMsT0FBTyxZQUFZLENBQUMsUUFBUSxFQUFFLENBQUM7SUFDakMsQ0FBQztJQUdEOzs7OztPQUtHO0lBQ0ksOEJBQVEsR0FBZixVQUFnQixhQUErQixFQUFFLEtBQWE7UUFDNUQsYUFBYSxDQUFDLGFBQWEsQ0FBQyxhQUFhLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFFbEQsSUFBSSxJQUFJLENBQUMsVUFBVSxDQUFDLGFBQWEsQ0FBQyxDQUFDLE1BQU0sS0FBSyxDQUFDLElBQUksSUFBSSxDQUFDLFVBQVUsQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxHQUFHLEVBQUU7WUFDNUYsSUFBSSxDQUFDLFVBQVUsQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDO1NBQzFDO2FBQU07WUFDTCxJQUFJLElBQUksQ0FBQyxVQUFVLENBQUMsYUFBYSxDQUFDLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsRUFBRTtnQkFDckQsSUFBSSxDQUFDLFVBQVUsQ0FBQyxhQUFhLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7YUFDNUM7U0FDRjtJQUNILENBQUM7SUFBQSxDQUFDO0lBRUY7Ozs7O09BS0c7SUFDSSxpQ0FBVyxHQUFsQixVQUFtQixhQUErQixFQUFFLEtBQWE7UUFDL0QsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsYUFBYSxDQUFDLEVBQUU7WUFDbkMsTUFBTSxJQUFJLEtBQUssQ0FBQywrQ0FBNkMsbUJBQW1CLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBRyxDQUFDLENBQUM7U0FDaEc7UUFFRCxJQUFJLElBQUksQ0FBQyxVQUFVLENBQUMsYUFBYSxDQUFDLENBQUMsTUFBTSxLQUFLLENBQUMsSUFBSSxJQUFJLENBQUMsVUFBVSxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLEdBQUcsRUFBRTtZQUM1RixPQUFPLENBQUMsR0FBRyxDQUFDLGlCQUFpQixHQUFHLGFBQWEsR0FBRyw2REFBNkQsQ0FBQyxDQUFDO1lBRS9HLE9BQU87U0FDUjtRQUVELElBQUksQ0FBQyxVQUFVLENBQUMsYUFBYSxDQUFDLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxhQUFhLENBQUMsQ0FBQyxNQUFNLENBQUMsVUFBQyxTQUFTO1lBQy9FLE9BQU8sS0FBSyxLQUFLLFNBQVMsQ0FBQztRQUM3QixDQUFDLENBQUMsQ0FBQztRQUVILElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLGFBQWEsQ0FBQyxDQUFDLE1BQU0sRUFBRTtZQUMxQyxJQUFJLENBQUMsVUFBVSxDQUFDLGFBQWEsQ0FBQyxHQUFHLGdCQUFnQixDQUFDO1NBQ25EO0lBQ0gsQ0FBQztJQUFBLENBQUM7SUFnQksseUJBQUcsR0FBVixVQUFXLGFBQStCLEVBQUUsT0FBNkI7UUFDdkUsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsYUFBYSxDQUFDLEVBQUU7WUFDbkMsTUFBTSxJQUFJLEtBQUssQ0FBQywrQ0FBNkMsbUJBQW1CLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBRyxDQUFDLENBQUM7U0FDaEc7UUFHQyxJQUFBLHNGQUFNLENBQ3lCO1FBRWpDLElBQUksQ0FBQyxNQUFNLEVBQUU7WUFDWCxPQUFPLElBQUksQ0FBQyxVQUFVLENBQUMsYUFBYSxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1NBQ2pEO1FBRUQsSUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxFQUFFLE1BQU0sUUFBQSxFQUFFLENBQUMsQ0FBQztRQUUzQyxPQUFPLFVBQVUsQ0FBQyxhQUFhLENBQUMsQ0FBQztJQUNuQyxDQUFDO0lBd0JNLDRCQUFNLEdBQWIsVUFBYyxPQUE2QjtRQUV2QyxJQUFBLHNGQUFNLENBQ3lCO1FBRWpDLElBQUksQ0FBQyxNQUFNLEVBQUU7WUFDWCxPQUFPLElBQUksQ0FBQyxVQUFVLENBQUM7U0FDeEI7UUFFRCxJQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7UUFDL0MsSUFBTSxZQUFZLEdBQUcsSUFBSSxJQUFJLEVBQUUsQ0FBQztRQUNoQyxZQUFZLENBQUMsVUFBVSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQ3BDLElBQU0sU0FBUyxHQUFHLFlBQVksQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUV6QyxPQUFPO1lBQ0wsTUFBTSxFQUFFLFNBQVMsQ0FBQyxDQUFDLENBQUM7WUFDcEIsSUFBSSxFQUFFLFNBQVMsQ0FBQyxDQUFDLENBQUM7WUFDbEIsYUFBYSxFQUFFLFNBQVMsQ0FBQyxDQUFDLENBQUM7WUFDM0IsS0FBSyxFQUFFLFNBQVMsQ0FBQyxDQUFDLENBQUM7WUFDbkIsWUFBWSxFQUFFLFNBQVMsQ0FBQyxDQUFDLENBQUM7U0FDM0IsQ0FBQTtJQUNILENBQUM7SUFFRDs7Ozs7OztPQU9HO0lBQ0kseUJBQUcsR0FBVixVQUFXLGFBQStCLEVBQUUsS0FBZTs7UUFDekQsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLEVBQUU7WUFDekIsTUFBTSxJQUFJLEtBQUssQ0FBQyx1REFBdUQsQ0FBQyxDQUFDO1NBQzFFOztZQUVELEtBQW1CLElBQUEsVUFBQSxTQUFBLEtBQUssQ0FBQSw0QkFBQSwrQ0FBRTtnQkFBckIsSUFBTSxJQUFJLGtCQUFBO2dCQUNiLGFBQWEsQ0FBQyxhQUFhLENBQUMsYUFBYSxFQUFFLElBQUksQ0FBQyxDQUFDO2FBQ2xEOzs7Ozs7Ozs7UUFFRCxJQUFJLENBQUMsVUFBVSxDQUFDLGFBQWEsQ0FBQyxHQUFHLEtBQUssQ0FBQztRQUV2QyxPQUFPLElBQUksQ0FBQyxVQUFVLENBQUMsYUFBYSxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ2xELENBQUM7SUFFRDs7Ozs7Ozs7OztPQVVHO0lBQ0ksNEJBQU0sR0FBYixVQUFjLFFBQW9CO1FBQWxDLGlCQUlDO1FBSEMsYUFBYSxDQUFDLGtCQUFrQixDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBRTNDLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsT0FBTyxDQUFDLFVBQUMsR0FBRyxJQUFLLE9BQUEsS0FBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsR0FBRyxRQUFRLENBQUMsR0FBRyxDQUFDLEVBQXBDLENBQW9DLENBQUMsQ0FBQTtJQUM5RSxDQUFDO0lBQ0gsa0JBQUM7QUFBRCxDQUFDLEFBL05ELElBK05DIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgQ3JvbiBmcm9tIFwiY3Jvbi1jb252ZXJ0ZXJcIjtcclxuXHJcbmltcG9ydCB7IENyb25WYWxpZGF0b3IgfSBmcm9tICcuL2Nyb24tdmFsaWRhdG9yJztcclxuaW1wb3J0IHsgREVGQVVMVF9JTlRFUlZBTCwgRXhwYW5kZWRFeHByZXNzaW9uLCBFeHByZXNzaW9uLCBNRUFTVVJFX09GX1RJTUVfTUFQIH0gZnJvbSAnLi90eXBlcyc7XHJcbmltcG9ydCB7IGtleXMgfSBmcm9tICcuL3V0aWxzJztcclxuXHJcbi8qKlxyXG4gKiBJbml0aWFsaXplcyBhIENyb25CdWlsZGVyIHdpdGggYW4gb3B0aW9uYWwgaW5pdGlhbCBjcm9uIGV4cHJlc3Npb24uXHJcbiAqIEBwYXJhbSB7U3RyaW5nPX0gaW5pdGlhbEV4cHJlc3Npb24gLSBpZiBwcm92aWRlZCwgaXQgbXVzdCBiZSB1cCB0byA1IHNwYWNlIGRlbGltaXRlZCBwYXJ0c1xyXG4gKiBAdGhyb3dzIHtFcnJvcn0gaWYgdGhlIGluaXRpYWxFeHByZXNzaW9uIGlzIGJvZ3VzXHJcbiAqIEBjb25zdHJ1Y3RvclxyXG4gKi9cclxuZXhwb3J0IGNsYXNzIENyb25CdWlsZGVyIHtcclxuICBwcml2YXRlIHJlYWRvbmx5IGV4cHJlc3Npb246IEV4cHJlc3Npb247XHJcblxyXG4gIGNvbnN0cnVjdG9yKGluaXRpYWxFeHByZXNzaW9uOiBzdHJpbmcgPSBcIiogKiAqICogKlwiKSB7XHJcbiAgICBpZiAoaW5pdGlhbEV4cHJlc3Npb24pIHtcclxuICAgICAgQ3JvblZhbGlkYXRvci52YWxpZGF0ZVN0cmluZyhpbml0aWFsRXhwcmVzc2lvbik7XHJcblxyXG4gICAgICBjb25zdCBzcGxpdEV4cHJlc3Npb24gPSBpbml0aWFsRXhwcmVzc2lvbi5zcGxpdCgnICcpO1xyXG5cclxuICAgICAgdGhpcy5leHByZXNzaW9uID0ge1xyXG4gICAgICAgIG1pbnV0ZTogc3BsaXRFeHByZXNzaW9uWzBdID8gc3BsaXRFeHByZXNzaW9uWzBdLnNwbGl0KFwiLFwiKSA6IERFRkFVTFRfSU5URVJWQUwsXHJcbiAgICAgICAgaG91cjogc3BsaXRFeHByZXNzaW9uWzFdID8gc3BsaXRFeHByZXNzaW9uWzFdLnNwbGl0KFwiLFwiKSA6IERFRkFVTFRfSU5URVJWQUwsXHJcbiAgICAgICAgZGF5T2ZUaGVNb250aDogc3BsaXRFeHByZXNzaW9uWzJdID8gc3BsaXRFeHByZXNzaW9uWzJdLnNwbGl0KFwiLFwiKSA6IERFRkFVTFRfSU5URVJWQUwsXHJcbiAgICAgICAgbW9udGg6IHNwbGl0RXhwcmVzc2lvblszXSA/IHNwbGl0RXhwcmVzc2lvblszXS5zcGxpdChcIixcIikgOiBERUZBVUxUX0lOVEVSVkFMLFxyXG4gICAgICAgIGRheU9mVGhlV2Vlazogc3BsaXRFeHByZXNzaW9uWzRdID8gc3BsaXRFeHByZXNzaW9uWzRdLnNwbGl0KFwiLFwiKSA6IERFRkFVTFRfSU5URVJWQUwsXHJcbiAgICAgIH07XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0aGlzLmV4cHJlc3Npb24gPSB7XHJcbiAgICAgICAgbWludXRlOiBERUZBVUxUX0lOVEVSVkFMLFxyXG4gICAgICAgIGhvdXI6IERFRkFVTFRfSU5URVJWQUwsXHJcbiAgICAgICAgZGF5T2ZUaGVNb250aDogREVGQVVMVF9JTlRFUlZBTCxcclxuICAgICAgICBtb250aDogREVGQVVMVF9JTlRFUlZBTCxcclxuICAgICAgICBkYXlPZlRoZVdlZWs6IERFRkFVTFRfSU5URVJWQUwsXHJcbiAgICAgIH07XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBidWlsZHMgYSB3b3JraW5nIGNyb24gZXhwcmVzc2lvbiBiYXNlZCBvbiB0aGUgc3RhdGUgb2YgdGhlIGNyb24gb2JqZWN0XHJcbiAgICogQHBhcmFtIHshT2JqZWN0fSBbb3B0aW9uc10gLSBjdXN0b21pemUgaG93IHRvIGJ1aWxkIGNyb24gc3RyaW5nXHJcbiAgICogQHBhcmFtIHshQm9vbGVhbn0gW29wdGlvbnMucGxhaW49dHJ1ZV0gLSBnZXQgY3JvbiBzdHJpbmcgYXMgaXQgaXMsIG90aGVyd2lzZSBidWlsZCBzaG9ydCBjcm9uIHN0cmluZy5cclxuICAgKiBpZiBmYWxzZTogKiAxMyAqIDEtNiAwLDEsMiwzLDUsNiAtLS0+ICogMTMgKiAxLTYgMC0zLDUtNlxyXG4gICAqIEBwYXJhbSB7IUJvb2xlYW59IFtvcHRpb25zLm91dHB1dFdlZWtkYXlOYW1lcz1mYWxzZV0gLSBjaGFuZ2VzIHRoZSBudW1iZXJzIHRvIDMgbGV0dGVyIHdlZWtkYXkgbmFtZXMuXHJcbiAgICogaWYgdHJ1ZTogKlxcLzUgOS0xNy8yICogMS0zIDEtNSAtLS0+ICpcXC81ICooMTAtMTYpLzIgKiBKQU4tTUFSIE1PTi1GUklcclxuICAgKiBAcGFyYW0geyFCb29sZWFufSBbb3B0aW9ucy5vdXRwdXRNb250aE5hbWVzPWZhbHNlXSAtIGNoYW5nZXMgdGhlIG51bWJlcnMgdG8gMyBsZXR0ZXIgbW9udGggbmFtZXMuXHJcbiAgICogaWYgdHJ1ZTogKlxcLzUgOS0xNy8yICogMS0zIDEtNSAtLS0+ICpcXC81ICooMTAtMTYpLzIgKiBKQU4tTUFSIE1PTi1GUklcclxuICAgKiBAcGFyYW0geyFCb29sZWFufSBbb3B0aW9ucy5vdXRwdXRIYXNoZXM9ZmFsc2VdIC0gY2hhbmdlcyB0aGUgKiB0byBILlxyXG4gICAqIGlmIHRydWU6ICpcXC81IDktMTcvMiAqIDEtMyAxLTUgLS0tPiBILzUgSCgxMC0xNikvMiBIIDEtMyAxLTVcclxuICAgKiBAcmV0dXJucyB7c3RyaW5nfSAtIHdvcmtpbmcgY3JvbiBleHByZXNzaW9uXHJcbiAgICovXHJcbiAgcHVibGljIGJ1aWxkKG9wdGlvbnM/OiB7IHBsYWluOiBib29sZWFuIHwgdW5kZWZpbmVkIH0gJiBPbWl0PENyb24uT3B0aW9ucywgXCJ0aW1lem9uZVwiPik6IHN0cmluZyB7XHJcbiAgICBjb25zdCB7XHJcbiAgICAgIHBsYWluLFxyXG4gICAgfSA9IG9wdGlvbnMgPz8geyBwbGFpbjogdHJ1ZSB9O1xyXG5cclxuICAgIGNvbnN0IGNyb25TdHJpbmcgPSBbXHJcbiAgICAgIHRoaXMuZXhwcmVzc2lvbi5taW51dGUuam9pbignLCcpLFxyXG4gICAgICB0aGlzLmV4cHJlc3Npb24uaG91ci5qb2luKCcsJyksXHJcbiAgICAgIHRoaXMuZXhwcmVzc2lvbi5kYXlPZlRoZU1vbnRoLmpvaW4oJywnKSxcclxuICAgICAgdGhpcy5leHByZXNzaW9uLm1vbnRoLmpvaW4oJywnKSxcclxuICAgICAgdGhpcy5leHByZXNzaW9uLmRheU9mVGhlV2Vlay5qb2luKCcsJyksXHJcbiAgICBdLmpvaW4oJyAnKTtcclxuXHJcbiAgICBpZiAocGxhaW4pIHtcclxuICAgICAgcmV0dXJuIGNyb25TdHJpbmc7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgY3Jvbkluc3RhbmNlID0gbmV3IENyb24ob3B0aW9ucyk7XHJcbiAgICBjcm9uSW5zdGFuY2UuZnJvbVN0cmluZyhjcm9uU3RyaW5nKTtcclxuXHJcbiAgICByZXR1cm4gY3Jvbkluc3RhbmNlLnRvU3RyaW5nKCk7XHJcbiAgfVxyXG5cclxuXHJcbiAgLyoqXHJcbiAgICogYWRkcyBhIHZhbHVlIHRvIHdoYXQgZXhpc3RzIGN1cnJlbnRseSAoYnVpbGRzKVxyXG4gICAqIEBwYXJhbSB7IVN0cmluZ30gbWVhc3VyZU9mVGltZVxyXG4gICAqIEBwYXJhbSB7IVN0cmluZ30gdmFsdWVcclxuICAgKiBAdGhyb3dzIHtFcnJvcn0gaWYgbWVhc3VyZU9mVGltZSBvciB2YWx1ZSBmYWlsIHZhbGlkYXRpb25cclxuICAgKi9cclxuICBwdWJsaWMgYWRkVmFsdWUobWVhc3VyZU9mVGltZToga2V5b2YgRXhwcmVzc2lvbiwgdmFsdWU6IHN0cmluZyk6IHZvaWQge1xyXG4gICAgQ3JvblZhbGlkYXRvci52YWxpZGF0ZVZhbHVlKG1lYXN1cmVPZlRpbWUsIHZhbHVlKTtcclxuXHJcbiAgICBpZiAodGhpcy5leHByZXNzaW9uW21lYXN1cmVPZlRpbWVdLmxlbmd0aCA9PT0gMSAmJiB0aGlzLmV4cHJlc3Npb25bbWVhc3VyZU9mVGltZV1bMF0gPT09ICcqJykge1xyXG4gICAgICB0aGlzLmV4cHJlc3Npb25bbWVhc3VyZU9mVGltZV0gPSBbdmFsdWVdO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgaWYgKHRoaXMuZXhwcmVzc2lvblttZWFzdXJlT2ZUaW1lXS5pbmRleE9mKHZhbHVlKSA8IDApIHtcclxuICAgICAgICB0aGlzLmV4cHJlc3Npb25bbWVhc3VyZU9mVGltZV0ucHVzaCh2YWx1ZSk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9O1xyXG5cclxuICAvKipcclxuICAgKiByZW1vdmVzIGEgc2luZ2xlIGV4cGxpY2l0IHZhbHVlIChzdWJ0cmFjdHMpXHJcbiAgICogQHBhcmFtIHshU3RyaW5nfSBtZWFzdXJlT2ZUaW1lIC0gYXMgeW91IG1pZ2h0IGd1ZXNzXHJcbiAgICogQHBhcmFtIHshU3RyaW5nfSB2YWx1ZSAtIHRoZSBvZmZlbnNpdmUgdmFsdWVcclxuICAgKiBAdGhyb3dzIHtFcnJvcn0gaWYgbWVhc3VyZU9mVGltZSBpcyBib2d1cy5cclxuICAgKi9cclxuICBwdWJsaWMgcmVtb3ZlVmFsdWUobWVhc3VyZU9mVGltZToga2V5b2YgRXhwcmVzc2lvbiwgdmFsdWU6IHN0cmluZyk6IHZvaWQge1xyXG4gICAgaWYgKCF0aGlzLmV4cHJlc3Npb25bbWVhc3VyZU9mVGltZV0pIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIG1lYXN1cmVPZlRpbWU6IFZhbGlkIG9wdGlvbnMgYXJlOiAke01FQVNVUkVfT0ZfVElNRV9NQVAuam9pbignLCAnKX1gKTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAodGhpcy5leHByZXNzaW9uW21lYXN1cmVPZlRpbWVdLmxlbmd0aCA9PT0gMSAmJiB0aGlzLmV4cHJlc3Npb25bbWVhc3VyZU9mVGltZV1bMF0gPT09ICcqJykge1xyXG4gICAgICBjb25zb2xlLmxvZygnVGhlIHZhbHVlIGZvciBcIicgKyBtZWFzdXJlT2ZUaW1lICsgJ1wiIGlzIGFscmVhZHkgYXQgdGhlIGRlZmF1bHQgdmFsdWUgb2YgXCIqXCIgLSB0aGlzIGlzIGEgbm8tb3AuJyk7XHJcblxyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgdGhpcy5leHByZXNzaW9uW21lYXN1cmVPZlRpbWVdID0gdGhpcy5leHByZXNzaW9uW21lYXN1cmVPZlRpbWVdLmZpbHRlcigodGltZVZhbHVlKSA9PiB7XHJcbiAgICAgIHJldHVybiB2YWx1ZSAhPT0gdGltZVZhbHVlO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaWYgKCF0aGlzLmV4cHJlc3Npb25bbWVhc3VyZU9mVGltZV0ubGVuZ3RoKSB7XHJcbiAgICAgIHRoaXMuZXhwcmVzc2lvblttZWFzdXJlT2ZUaW1lXSA9IERFRkFVTFRfSU5URVJWQUw7XHJcbiAgICB9XHJcbiAgfTtcclxuXHJcbiAgLyoqXHJcbiAgICogcmV0dXJucyB0aGUgY3VycmVudCBzdGF0ZSBvZiBhIGdpdmVuIG1lYXN1cmVPZlRpbWVcclxuICAgKiBAcGFyYW0geyFTdHJpbmd9IG1lYXN1cmVPZlRpbWUgb25lIG9mIFwibWludXRlXCIsIFwiaG91clwiLCBldGNcclxuICAgKiBAcmV0dXJucyB7IUFycmF5Lm51bWJlcn0gY29tbWEgc2VwYXJhdGVkIGJsYWggYmxhaFxyXG4gICAqIEB0aHJvd3Mge0Vycm9yfSBpZiB0aGUgbWVhc3VyZU9mVGltZSBpcyBub3Qgb25lIG9mIHRoZSBwZXJtaXR0ZWQgdmFsdWVzLlxyXG4gICAqL1xyXG4gIHB1YmxpYyBnZXQobWVhc3VyZU9mVGltZToga2V5b2YgRXhwcmVzc2lvbiwgb3B0aW9uczogeyBleHBhbmQ6IHRydWUgfSk6IG51bWJlcltdXHJcbiAgLyoqXHJcbiAgICogcmV0dXJucyB0aGUgY3VycmVudCBzdGF0ZSBvZiBhIGdpdmVuIG1lYXN1cmVPZlRpbWVcclxuICAgKiBAcGFyYW0geyFTdHJpbmd9IG1lYXN1cmVPZlRpbWUgb25lIG9mIFwibWludXRlXCIsIFwiaG91clwiLCBldGNcclxuICAgKiBAcmV0dXJucyB7IVN0cmluZ30gY29tbWEgc2VwYXJhdGVkIGJsYWggYmxhaFxyXG4gICAqIEB0aHJvd3Mge0Vycm9yfSBpZiB0aGUgbWVhc3VyZU9mVGltZSBpcyBub3Qgb25lIG9mIHRoZSBwZXJtaXR0ZWQgdmFsdWVzLlxyXG4gICAqL1xyXG4gIHB1YmxpYyBnZXQobWVhc3VyZU9mVGltZToga2V5b2YgRXhwcmVzc2lvbiwgb3B0aW9ucz86IHsgZXhwYW5kOiBmYWxzZSB9KTogc3RyaW5nXHJcbiAgcHVibGljIGdldChtZWFzdXJlT2ZUaW1lOiBrZXlvZiBFeHByZXNzaW9uLCBvcHRpb25zPzogeyBleHBhbmQ6IGJvb2xlYW4gfSk6IHN0cmluZyB8IG51bWJlcltdIHtcclxuICAgIGlmICghdGhpcy5leHByZXNzaW9uW21lYXN1cmVPZlRpbWVdKSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCBtZWFzdXJlT2ZUaW1lOiBWYWxpZCBvcHRpb25zIGFyZTogJHtNRUFTVVJFX09GX1RJTUVfTUFQLmpvaW4oJywgJyl9YCk7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3Qge1xyXG4gICAgICBleHBhbmQsXHJcbiAgICB9ID0gb3B0aW9ucyA/PyB7IGV4cGFuZDogZmFsc2UgfTtcclxuXHJcbiAgICBpZiAoIWV4cGFuZCkge1xyXG4gICAgICByZXR1cm4gdGhpcy5leHByZXNzaW9uW21lYXN1cmVPZlRpbWVdLmpvaW4oJywnKTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBleHByZXNzaW9uID0gdGhpcy5nZXRBbGwoeyBleHBhbmQgfSk7XHJcblxyXG4gICAgcmV0dXJuIGV4cHJlc3Npb25bbWVhc3VyZU9mVGltZV07XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBSZXR1cm5zIGEgcmljaCBvYmplY3QgdGhhdCBkZXNjcmliZXMgdGhlIGN1cnJlbnQgc3RhdGUgb2YgdGhlIGNyb24gZXhwcmVzc2lvbi5cclxuICAgKiBAcmV0dXJucyB7IXtcclxuICAgKiAgbWludXRlOiBBcnJheS5udW1iZXIsXHJcbiAgICogIGhvdXI6IEFycmF5Lm51bWJlcixcclxuICAgKiAgZGF5T2ZUaGVNb250aDogQXJyYXkubnVtYmVyLFxyXG4gICAqICBtb250aDogQXJyYXkubnVtYmVyLFxyXG4gICAqICBkYXlPZlRoZVdlZWs6IEFycmF5Lm51bWJlcixcclxuICAgKiB9fVxyXG4gICAqL1xyXG4gIHB1YmxpYyBnZXRBbGwob3B0aW9uczogeyBleHBhbmQ6IHRydWUgfSk6IEV4cGFuZGVkRXhwcmVzc2lvblxyXG4gIC8qKlxyXG4gICAqIFJldHVybnMgYSByaWNoIG9iamVjdCB0aGF0IGRlc2NyaWJlcyB0aGUgY3VycmVudCBzdGF0ZSBvZiB0aGUgY3JvbiBleHByZXNzaW9uLlxyXG4gICAqIEByZXR1cm5zIHshe1xyXG4gICAqICBtaW51dGU6IEFycmF5LnN0cmluZyxcclxuICAgKiAgaG91cjogQXJyYXkuc3RyaW5nLFxyXG4gICAqICBkYXlPZlRoZU1vbnRoOiBBcnJheS5zdHJpbmcsXHJcbiAgICogIG1vbnRoOiBBcnJheS5zdHJpbmcsXHJcbiAgICogIGRheU9mVGhlV2VlazogQXJyYXkuc3RyaW5nLFxyXG4gICAqIH19XHJcbiAgICovXHJcbiAgcHVibGljIGdldEFsbChvcHRpb25zPzogeyBleHBhbmQ6IGZhbHNlIH0pOiBFeHByZXNzaW9uXHJcbiAgcHVibGljIGdldEFsbChvcHRpb25zPzogeyBleHBhbmQ6IGJvb2xlYW4gfSk6IEV4cHJlc3Npb24gfCBFeHBhbmRlZEV4cHJlc3Npb24ge1xyXG4gICAgY29uc3Qge1xyXG4gICAgICBleHBhbmQsXHJcbiAgICB9ID0gb3B0aW9ucyA/PyB7IGV4cGFuZDogZmFsc2UgfTtcclxuXHJcbiAgICBpZiAoIWV4cGFuZCkge1xyXG4gICAgICByZXR1cm4gdGhpcy5leHByZXNzaW9uO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IGNyb25TdHJpbmcgPSB0aGlzLmJ1aWxkKHsgcGxhaW46IHRydWUgfSk7XHJcbiAgICBjb25zdCBjcm9uSW5zdGFuY2UgPSBuZXcgQ3JvbigpO1xyXG4gICAgY3Jvbkluc3RhbmNlLmZyb21TdHJpbmcoY3JvblN0cmluZyk7XHJcbiAgICBjb25zdCBjcm9uQXJyYXkgPSBjcm9uSW5zdGFuY2UudG9BcnJheSgpO1xyXG5cclxuICAgIHJldHVybiB7XHJcbiAgICAgIG1pbnV0ZTogY3JvbkFycmF5WzBdLFxyXG4gICAgICBob3VyOiBjcm9uQXJyYXlbMV0sXHJcbiAgICAgIGRheU9mVGhlTW9udGg6IGNyb25BcnJheVsyXSxcclxuICAgICAgbW9udGg6IGNyb25BcnJheVszXSxcclxuICAgICAgZGF5T2ZUaGVXZWVrOiBjcm9uQXJyYXlbNF0sXHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBzZXRzIHRoZSBzdGF0ZSBvZiBhIGdpdmVuIG1lYXN1cmVPZlRpbWVcclxuICAgKiBAcGFyYW0geyFTdHJpbmd9IG1lYXN1cmVPZlRpbWUgLSB5dXBcclxuICAgKiBAcGFyYW0geyFBcnJheS48U3RyaW5nPn0gdmFsdWUgLSB0aGUgNSB0dXBsZSBhcnJheSBvZiB2YWx1ZXMgdG8gc2V0XHJcbiAgICogQHJldHVybnMgeyFTdHJpbmd9IHRoZSBjb21tYSBzZXBhcmF0ZWQgdmVyc2lvbiBvZiB0aGUgdmFsdWUgdGhhdCB5b3UgcGFzc2VkIGluXHJcbiAgICogQHRocm93cyB7RXJyb3J9IGlmIHlvdXIgXCJ2YWx1ZVwiIGlzIG5vdCBhbiBBcnJheSZsdDtTdHJpbmcmZ3Q7XHJcbiAgICogQHRocm93cyB7RXJyb3J9IHdoZW4gYW55IGl0ZW0gaW4geW91ciB2YWx1ZSBpc24ndCBhIGxlZ2FsIGNyb24taXNoIGRlc2NyaXB0b3JcclxuICAgKi9cclxuICBwdWJsaWMgc2V0KG1lYXN1cmVPZlRpbWU6IGtleW9mIEV4cHJlc3Npb24sIHZhbHVlOiBzdHJpbmdbXSk6IHN0cmluZyB7XHJcbiAgICBpZiAoIUFycmF5LmlzQXJyYXkodmFsdWUpKSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCB2YWx1ZTsgVmFsdWUgbXVzdCBiZSBpbiB0aGUgZm9ybSBvZiBhbiBBcnJheS4nKTtcclxuICAgIH1cclxuXHJcbiAgICBmb3IgKGNvbnN0IGl0ZW0gb2YgdmFsdWUpIHtcclxuICAgICAgQ3JvblZhbGlkYXRvci52YWxpZGF0ZVZhbHVlKG1lYXN1cmVPZlRpbWUsIGl0ZW0pO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMuZXhwcmVzc2lvblttZWFzdXJlT2ZUaW1lXSA9IHZhbHVlO1xyXG5cclxuICAgIHJldHVybiB0aGlzLmV4cHJlc3Npb25bbWVhc3VyZU9mVGltZV0uam9pbignLCcpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogc2V0cyB0aGUgc3RhdGUgZm9yIHRoZSBlbnRpcmUgY3JvbiBleHByZXNzaW9uXHJcbiAgICogQHBhcmFtIHshe1xyXG4gICAqICBtaW51dGU6IEFycmF5LnN0cmluZyxcclxuICAgKiAgaG91cjogQXJyYXkuc3RyaW5nLFxyXG4gICAqICBkYXlPZlRoZU1vbnRoOiBBcnJheS5zdHJpbmcsXHJcbiAgICogIG1vbnRoOiBBcnJheS5zdHJpbmcsXHJcbiAgICogIGRheU9mVGhlV2VlazogQXJyYXkuc3RyaW5nLFxyXG4gICAqIH19IGV4cFRvU2V0IC0gdGhlIGVudGlyZXR5IG9mIHRoZSBjcm9uIGV4cHJlc3Npb24uXHJcbiAgICogQHRocm93cyB7RXJyb3J9IGFzIHVzdWFsXHJcbiAgICovXHJcbiAgcHVibGljIHNldEFsbChleHBUb1NldDogRXhwcmVzc2lvbik6IHZvaWQge1xyXG4gICAgQ3JvblZhbGlkYXRvci52YWxpZGF0ZUV4cHJlc3Npb24oZXhwVG9TZXQpO1xyXG5cclxuICAgIGtleXModGhpcy5leHByZXNzaW9uKS5mb3JFYWNoKChrZXkpID0+IHRoaXMuZXhwcmVzc2lvbltrZXldID0gZXhwVG9TZXRba2V5XSlcclxuICB9XHJcbn1cclxuIl19